# Настройка интеграции с Тильдой

## Описание

Система автоматической верификации вебхуков от Тильды позволяет:
- Автоматически получать данные из форм на сайте Тильды
- Верифицировать подлинность запросов
- Обрабатывать различные типы форм (регистрация, заявки, обратная связь)

## Шаг 1: Настройка переменных окружения

Добавьте в файл `.env`:

```env
# Tilda Integration
TILDA_WEBHOOK_SECRET=your-webhook-secret-here
TILDA_API_KEY=your-api-key-here  # Опционально
```

**Важно:** `TILDA_WEBHOOK_SECRET` рекомендуется установить для безопасности в production.

## Шаг 2: Настройка вебхука в Тильде

1. Войдите в личный кабинет Тильды
2. Откройте нужный сайт
3. Перейдите в **Настройки сайта** → **Формы**
4. Выберите **Webhook**
5. Укажите URL вашего сервера:
   ```
   https://ваш-домен.com/api/tilda/webhook
   ```
6. (Опционально) Установите секретный токен и добавьте его в `.env` как `TILDA_WEBHOOK_SECRET`
7. Выберите формат данных:
   - `application/json` (рекомендуется)
   - `application/x-www-form-urlencoded` (также поддерживается)
8. Сохраните изменения

## Шаг 3: Связывание формы с вебхуком

1. Откройте страницу с формой в режиме редактирования
2. Перейдите в **Контент** блока формы
3. В разделе **Подключенные сервисы** отметьте созданный вебхук
4. Сохраните изменения и опубликуйте страницу

## Шаг 4: Проверка работы

1. Отправьте тестовую форму на сайте Тильды
2. Проверьте логи сервера - должны появиться сообщения о получении данных
3. Проверьте, что данные обрабатываются корректно

## Формат данных

Тильда отправляет данные в следующем формате:

```json
{
  "formid": "123456",
  "formname": "Contact Form",
  "pageurl": "https://example.com/contact",
  "email": "user@example.com",
  "name": "John Doe",
  "phone": "+1234567890",
  ...
}
```

## Обработка различных типов форм

Система автоматически определяет тип формы по `formid` или `formname`:

- **Регистрация** - если содержит "register" или "регистрация"
- **Заявка** - если содержит "application" или "заявка"
- **Обратная связь** - если содержит "contact" или "контакт"

Вы можете настроить обработку в файле `src/controllers/tildaController.ts`.

## Безопасность

1. **Верификация подписи:** Если установлен `TILDA_WEBHOOK_SECRET`, все запросы проверяются
2. **HTTPS:** Обязательно используйте HTTPS для вебхука в production
3. **Таймаут:** Тильда ожидает ответ в течение 5 секунд

## Endpoints

- `POST /api/tilda/webhook` - основной endpoint для приема данных форм
- `GET /api/tilda/health` - проверка работоспособности сервиса

## Отладка

В режиме разработки (`NODE_ENV=development`) все данные форм логируются в консоль.

Для просмотра логов:
```bash
npm run dev
# или
docker-compose logs -f app
```

